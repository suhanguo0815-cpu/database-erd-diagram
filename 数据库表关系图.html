<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“è¡¨å…³ç³»å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            border-left: 4px solid #4CAF50;
            padding-left: 10px;
        }
        .mermaid {
            text-align: center;
            background: white;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            overflow-x: auto;
            position: relative;
        }
        
        .mermaid svg {
            position: relative;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        .tip {
            background: #fff3e0;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #FF9800;
        }
        .legend {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        .legend h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AIè¥å…»å¸ˆå°ç¨‹åº - æ•°æ®åº“è¡¨å…³ç³»å›¾</h1>
        
        <div class="info">
            <strong>ğŸ“Œ è¯´æ˜ï¼š</strong>è¿™æ˜¯ä¸€ä¸ªäº¤äº’å¼æ•°æ®åº“å…³ç³»å›¾ï¼Œå±•ç¤ºäº†æ‰€æœ‰è¡¨ä¹‹é—´çš„å…³è”å…³ç³»ã€‚å›¾è¡¨ä¼šè‡ªåŠ¨æ¸²æŸ“ï¼Œå¦‚æœçœ‹ä¸åˆ°å›¾è¡¨ï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸ã€‚
        </div>

        <div class="legend">
            <h3>ğŸ¨ ä¼˜å…ˆçº§å›¾ä¾‹</h3>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin: 15px 0;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 20px; background: #4CAF50; border-radius: 4px; border: 2px solid #2E7D32;"></div>
                    <span><strong>P0</strong> - æœ€é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ï¼Œæ ¸å¿ƒåŠŸèƒ½ï¼‰</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 20px; background: #FF9800; border-radius: 4px; border: 2px solid #F57C00;"></div>
                    <span><strong>P1</strong> - ä¸­ç­‰ä¼˜å…ˆçº§ï¼ˆé‡è¦åŠŸèƒ½ï¼‰</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 20px; background: #9E9E9E; border-radius: 4px; border: 2px solid #616161;"></div>
                    <span><strong>P2</strong> - ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰</span>
                </div>
            </div>
        </div>

        <h2>ä¸€ã€å®Œæ•´æ•°æ®åº“å…³ç³»å›¾ï¼ˆå¸¦ä¼˜å…ˆçº§æ ‡æ³¨ï¼‰</h2>
        <div class="mermaid">
erDiagram
    %% P0ä¼˜å…ˆçº§è¡¨ï¼ˆç»¿è‰²ï¼‰- æœ€é«˜ä¼˜å…ˆçº§ï¼Œæ ¸å¿ƒåŠŸèƒ½
    user_core {
        string userId PK "å…¨å±€ç”¨æˆ·ID [P0]"
        string wechatOpenId UK "å¾®ä¿¡OpenId"
        string nickname "æ˜µç§°"
        string phoneEncrypted "åŠ å¯†æ‰‹æœºå·"
        string phoneMasked "è„±æ•æ‰‹æœºå·"
    }
    
    user_goals {
        string userId PK "ç”¨æˆ·IDï¼ˆè”åˆä¸»é”®ï¼Œå…³è” user_core.userIdï¼‰"
        int version PK "ç‰ˆæœ¬å·ï¼ˆè”åˆä¸»é”®ï¼‰"
        number targetWeightKg "ç›®æ ‡ä½“é‡"
        int dailyCaloriesKcal "æ—¥ç›®æ ‡å¡è·¯é‡Œ"
    }
    
    user_subscriptions {
        string subscriptionId PK "è®¢é˜…ID [P0]"
        string userId FK "ç”¨æˆ·ID"
        string productPlanId FK "äº§å“æ–¹æ¡ˆID"
        string serviceStatus "æœåŠ¡çŠ¶æ€"
        bool isCurrent "æ˜¯å¦å½“å‰è®¢é˜…"
    }
    
    nutritionists {
        string nutritionistId PK "è¥å…»å¸ˆID [P0]"
        string displayName "æ˜¾ç¤ºåç§°"
        string wechatOpenId "å¾®ä¿¡OpenId"
    }
    
    meals {
        string mealId PK "é¤é£Ÿè®°å½•ID [P0]"
        string userId FK "ç”¨æˆ·ID"
        timestamp mealTimeUtc "è¿›é¤æ—¶é—´"
        int caloriesKcal "æ€»çƒ­é‡"
        json nutritionDetails "å®Œæ•´è¥å…»ç´ "
        number antiScore "æŠ—ç‚æ€»åˆ†"
    }
    
    weight {
        string weightId PK "ä½“é‡è®°å½•ID [P0]"
        string userId FK "ç”¨æˆ·ID"
        timestamp measuredAtUtc "æµ‹é‡æ—¶é—´"
        number weightKg "ä½“é‡"
    }
    
    exercise {
        string exerciseId PK "è¿åŠ¨è®°å½•ID [P0]"
        string userId FK "ç”¨æˆ·ID"
        timestamp activityAtUtc "è¿åŠ¨æ—¶é—´"
        int caloriesKcal "æ¶ˆè€—çƒ­é‡"
    }
    
    user_assessments {
        string assessmentId PK "è¯„ä¼°è®°å½•ID [P0]"
        string userId FK "ç”¨æˆ·ID"
        int version "è¯„ä¼°ç‰ˆæœ¬å·"
        number emotionalScore "æƒ…ç»ªå› å­å¾—åˆ†"
    }
    
    %% P1ä¼˜å…ˆçº§è¡¨ï¼ˆæ©™è‰²ï¼‰- ä¸­ç­‰ä¼˜å…ˆçº§
    user_preferences {
        string userId PK "ç”¨æˆ·ID [P1]"
        string personality "AIè¯­æ°”"
        json reminders "æé†’è®¾ç½®"
    }
    
    water {
        string waterId PK "å–æ°´è®°å½•ID [P1]"
        string userId FK "ç”¨æˆ·ID"
        timestamp drinkAtUtc "é¥®æ°´æ—¶é—´"
        int amountMl "é¥®æ°´é‡"
    }
    
    reports {
        string reportId PK "æŠ¥å‘ŠID [P1]"
        string userId FK "ç”¨æˆ·ID"
        string reportType "æŠ¥å‘Šç±»å‹"
        json metricsSnapshot "æŒ‡æ ‡å¿«ç…§"
    }
    
    conversation {
        string conversationId PK "å¯¹è¯ID [P1]"
        string userId FK "ç”¨æˆ·ID"
        timestamp occurredAtUtc "å‘ç”Ÿæ—¶é—´"
        string intent "æ„å›¾"
    }
    
    medical_reports {
        string reportId PK "æŠ¥å‘ŠID [P1]"
        string userId FK "ç”¨æˆ·ID"
        timestamp reportAtUtc "æŠ¥å‘Šæ—¥æœŸ"
        string fileUrl "æŠ¥å‘Šæ–‡ä»¶URL"
    }
    
    %% P2ä¼˜å…ˆçº§è¡¨ï¼ˆç°è‰²ï¼‰- ä½ä¼˜å…ˆçº§
    product_plans {
        string productPlanId PK "äº§å“æ–¹æ¡ˆID [P2]"
        string productPlanName "æ–¹æ¡ˆåç§°"
        string productPlanTier "æ–¹æ¡ˆå±‚çº§"
        number basePrice "åŸºç¡€ä»·æ ¼"
    }
    
    user_service_assignment {
        string userId PK "ç”¨æˆ·ID [P2]"
        string nutritionistId FK "è¥å…»å¸ˆID"
        string assignmentStatus "åˆ†é…çŠ¶æ€"
    }
    
    user_service_assignment_history {
        string userId FK "ç”¨æˆ·ID"
        string fromNutritionistId FK "åŸè¥å…»å¸ˆID"
        string toNutritionistId FK "æ–°è¥å…»å¸ˆID"
        timestamp changedAtUtc PK "å˜æ›´æ—¶é—´ [P2]"
    }
    
    payments {
        string paymentId PK "æ”¯ä»˜ID [P2]"
        string userId FK "ç”¨æˆ·ID"
        string subscriptionId FK "è®¢é˜…ID"
        number amount "é‡‘é¢"
        string status "æ”¯ä»˜çŠ¶æ€"
    }
    
    refunds {
        string refundId PK "é€€æ¬¾ID [P2]"
        string paymentId FK "æ”¯ä»˜ID"
        number amount "é€€æ¬¾é‡‘é¢"
        string status "é€€æ¬¾çŠ¶æ€"
    }
    
    %% å…³ç³»å®šä¹‰
    user_core ||--o{ user_goals : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªç›®æ ‡ç‰ˆæœ¬"
    user_core ||--o| user_preferences : "ç”¨æˆ·å¯é€‰åå¥½è®¾ç½®"
    user_core ||--o{ user_subscriptions : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è®°å½•"
    user_core ||--o| user_service_assignment : "ç”¨æˆ·å¯é€‰å½“å‰åˆ†é…"
    user_core ||--o{ user_service_assignment_history : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªåˆ†é…å†å²"
    user_core ||--o{ meals : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªé¤é£Ÿè®°å½•"
    user_core ||--o{ weight : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªä½“é‡è®°å½•"
    user_core ||--o{ exercise : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè¿åŠ¨è®°å½•"
    user_core ||--o{ user_assessments : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæµ‹è¯„"
    user_core ||--o{ water : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå–æ°´è®°å½•"
    user_core ||--o{ reports : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæŠ¥å‘Š"
    user_core ||--o{ medical_reports : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªä½“æ£€æŠ¥å‘Š"
    user_core ||--o{ conversation : "ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå¯¹è¯"
    
    product_plans o{--o| user_subscriptions : "äº§å“æ–¹æ¡ˆå¯é€‰å…³è”è®¢é˜…"
    
    nutritionists ||--o{ user_service_assignment : "è¥å…»å¸ˆå¯ä»¥åˆ†é…å¤šä¸ªç”¨æˆ·"
    nutritionists ||--o{ user_service_assignment_history : "ä½œä¸ºåŸè¥å…»å¸ˆ"
    nutritionists ||--o{ user_service_assignment_history : "ä½œä¸ºæ–°è¥å…»å¸ˆ"
    
    user_subscriptions o{--o| payments : "è®¢é˜…å¯é€‰å…³è”æ”¯ä»˜è®°å½•"
    
    payments ||--o{ refunds : "æ”¯ä»˜å¯ä»¥æœ‰å¤šä¸ªé€€æ¬¾è®°å½•"
        </div>

        <h2>äºŒã€å…³ç³»è¯´æ˜</h2>
        
        <h3>ç”¨æˆ·åŸŸï¼ˆUser Domainï¼‰</h3>
        <ul>
            <li><strong>user_core</strong>ï¼šç”¨æˆ·ä¸»æ¡£ï¼ˆå·²åˆå¹¶user_contactsï¼‰ï¼Œæ˜¯æ‰€æœ‰ä¸šåŠ¡äº‹å®è¡¨çš„ä¸­å¿ƒ</li>
            <li><strong>user_preferences</strong>ï¼šç”¨æˆ·åå¥½è®¾ç½®ï¼ˆ0æˆ–1ï¼Œç”¨æˆ·å¯é€‰ï¼‰</li>
            <li><strong>user_goals</strong>ï¼šç”¨æˆ·ç›®æ ‡ï¼ˆ1:Nå…³ç³»ï¼Œæ”¯æŒç‰ˆæœ¬åŒ–ï¼‰</li>
        </ul>

        <h3>æœåŠ¡åŸŸï¼ˆService Domainï¼‰</h3>
        <ul>
            <li><strong>product_plans</strong>ï¼šäº§å“æ–¹æ¡ˆæ¨¡æ¿ï¼ˆä¸ç›´æ¥å…³è”ç”¨æˆ·ï¼Œå¯è¢«è®¢é˜…å¼•ç”¨ï¼‰</li>
            <li><strong>user_subscriptions</strong>ï¼šè®¢é˜…/æœåŠ¡ï¼ˆå·²åˆå¹¶subscriptionså’Œuser_serviceï¼Œè®¡åˆ’å¼•ç”¨å¯ç©ºï¼‰</li>
            <li><strong>user_service_assignment</strong>ï¼šè¥å…»å¸ˆåˆ†é…ï¼ˆ0æˆ–1ï¼Œå½“å‰åˆ†é…ï¼Œå¯ç©ºï¼‰</li>
            <li><strong>user_service_assignment_history</strong>ï¼šåˆ†é…å†å²ï¼ˆ1:Nå…³ç³»ï¼‰</li>
            <li><strong>nutritionists</strong>ï¼šè¥å…»å¸ˆä¿¡æ¯</li>
        </ul>

        <h3>ä¸šåŠ¡äº‹å®åŸŸï¼ˆBusiness Facts Domainï¼‰</h3>
        <ul>
            <li>æ‰€æœ‰ä¸šåŠ¡äº‹å®è¡¨éƒ½ä¸ <strong>user_core</strong> ä¸€å¯¹å¤šå…³ç³»</li>
            <li><strong>meals</strong>ï¼šé¤é£Ÿè®°å½•ï¼ˆå·²åˆå¹¶meals_anti_scoreï¼Œæ–°å¢nutritionDetailsï¼‰</li>
            <li><strong>weight</strong>ï¼šä½“é‡è®°å½•</li>
            <li><strong>exercise</strong>ï¼šè¿åŠ¨è®°å½•</li>
            <li><strong>user_assessments</strong>ï¼šç”¨æˆ·æµ‹è¯„ï¼ˆç”»åƒ/å› å­å¾—åˆ†ï¼Œæ”¯æŒç‰ˆæœ¬åŒ–ï¼‰</li>
            <li><strong>water</strong>ï¼šå–æ°´è®°å½•</li>
            <li><strong>reports</strong>ï¼šæŠ¥å‘Šï¼ˆæ±‡æ€»ä»¥ä¸Šæ•°æ®ï¼‰</li>
            <li><strong>medical_reports</strong>ï¼šä½“æ£€æŠ¥å‘Š</li>
            <li><strong>conversation</strong>ï¼šå¯¹è¯è®°å½•</li>
        </ul>

        <h3>è´¢åŠ¡åŸŸï¼ˆFinance Domainï¼‰</h3>
        <ul>
            <li><strong>payments</strong>ï¼šæ”¯ä»˜è®°å½•ï¼ˆè®¢é˜…å…³è”å¯é€‰ï¼‰</li>
            <li><strong>refunds</strong>ï¼šé€€æ¬¾è®°å½•ï¼ˆå…³è”paymentsï¼‰</li>
        </ul>

        <div class="tip">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>
            <ul>
                <li>å›¾è¡¨å¯ä»¥é€šè¿‡é¼ æ ‡æ‹–æ‹½è°ƒæ•´ä½ç½®</li>
                <li>å¯ä»¥ç¼©æ”¾æŸ¥çœ‹ç»†èŠ‚</li>
                <li>å¦‚æœå›¾è¡¨æ²¡æœ‰æ˜¾ç¤ºï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            er: {
                fontSize: 12
            }
        });
        
        // åŸŸçš„å®šä¹‰
        const domains = {
            'ç”¨æˆ·åŸŸ': {
                tables: ['user_core', 'user_goals', 'user_preferences'],
                color: 'rgba(200, 230, 201, 0.2)',  // æµ…ç»¿è‰²èƒŒæ™¯
                borderColor: '#81C784',  // ç»¿è‰²è¾¹æ¡†
                textColor: '#2E7D32'
            },
            'æœåŠ¡åŸŸ': {
                tables: ['product_plans', 'user_subscriptions', 'user_service_assignment', 
                        'user_service_assignment_history', 'nutritionists'],
                color: 'rgba(187, 222, 251, 0.2)',  // æµ…è“è‰²èƒŒæ™¯
                borderColor: '#64B5F6',  // è“è‰²è¾¹æ¡†
                textColor: '#1976D2'
            },
            'ä¸šåŠ¡äº‹å®åŸŸ': {
                tables: ['meals', 'weight', 'exercise', 'user_assessments', 'water', 'reports', 'conversation', 'medical_reports'],
                color: 'rgba(255, 224, 178, 0.2)',  // æµ…æ©™è‰²èƒŒæ™¯
                borderColor: '#FFB74D',  // æ©™è‰²è¾¹æ¡†
                textColor: '#F57C00'
            },
            'è´¢åŠ¡åŸŸ': {
                tables: ['payments', 'refunds'],
                color: 'rgba(224, 224, 224, 0.2)',  // æµ…ç°è‰²èƒŒæ™¯
                borderColor: '#9E9E9E',  // ç°è‰²è¾¹æ¡†
                textColor: '#616161'
            }
        };
        
        // è®¾ç½®è¡¨é¢œè‰²çš„å‡½æ•°
        function setTableColors() {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) {
                // å¦‚æœSVGè¿˜æ²¡æ¸²æŸ“ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•
                setTimeout(setTableColors, 500);
                return;
            }
            
            // P0ä¼˜å…ˆçº§è¡¨ï¼ˆç»¿è‰²ï¼‰- æœ€é«˜ä¼˜å…ˆçº§ï¼Œæ ¸å¿ƒåŠŸèƒ½
            const p0Tables = ['user_core', 'user_goals', 'user_subscriptions', 
                             'nutritionists', 'meals', 'weight', 'exercise', 'user_assessments'];
            
            // P1ä¼˜å…ˆçº§è¡¨ï¼ˆæ©™è‰²ï¼‰- ä¸­ç­‰ä¼˜å…ˆçº§ï¼Œé‡è¦åŠŸèƒ½
            const p1Tables = ['user_preferences', 'water', 'reports', 'conversation', 'medical_reports'];
            
            // P2ä¼˜å…ˆçº§è¡¨ï¼ˆç°è‰²ï¼‰- ä½ä¼˜å…ˆçº§ï¼Œå¯é€‰åŠŸèƒ½
            // product_plans: ç›®å‰åªæœ‰ä¸€ä¸ªäº§å“æ–¹æ¡ˆï¼Œä¼˜å…ˆçº§è°ƒä½
            // user_service_assignment, user_service_assignment_history: è¥å…»å¸ˆæš‚ä¸æ”¹æ´¾ï¼Œä¼˜å…ˆçº§è°ƒä½
            const p2Tables = ['product_plans', 'user_service_assignment', 'user_service_assignment_history', 
                             'payments', 'refunds'];
            
            // æ›´å¯é çš„æ–¹æ³•ï¼šæŸ¥æ‰¾æ‰€æœ‰rectå…ƒç´ ï¼Œç„¶åé€šè¿‡æŸ¥æ‰¾é™„è¿‘çš„æ–‡æœ¬æ¥ç¡®å®šè¡¨å
            function findAndColorTable(tableName, fillColor, strokeColor) {
                // æ–¹æ³•1ï¼šé€šè¿‡æŸ¥æ‰¾åŒ…å«è¡¨åçš„æ–‡æœ¬å…ƒç´ ï¼Œç„¶åæ‰¾åˆ°æœ€è¿‘çš„rect
                const allTexts = svg.querySelectorAll('text');
                allTexts.forEach(textEl => {
                    const textContent = textEl.textContent || '';
                    // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«è¡¨åï¼ˆä½œä¸ºç¬¬ä¸€ä¸ªå•è¯ï¼‰
                    if (textContent.trim().startsWith(tableName)) {
                        // æ‰¾åˆ°åŒ…å«è¿™ä¸ªæ–‡æœ¬çš„ç»„
                        let group = textEl.closest('g');
                        if (group) {
                            // åœ¨ç»„å†…æŸ¥æ‰¾æ‰€æœ‰rectå…ƒç´ 
                            const rects = group.querySelectorAll('rect');
                            rects.forEach(rect => {
                                const width = parseFloat(rect.getAttribute('width') || 0);
                                const height = parseFloat(rect.getAttribute('height') || 0);
                                // è¡¨çš„ä¸»çŸ©å½¢é€šå¸¸è¾ƒå¤§ï¼ˆå®½åº¦>80ï¼Œé«˜åº¦>40ï¼‰
                                if (width > 80 && height > 40) {
                                    rect.setAttribute('fill', fillColor);
                                    rect.setAttribute('stroke', strokeColor);
                                    rect.setAttribute('stroke-width', '2');
                                    rect.style.fill = fillColor;
                                    rect.style.stroke = strokeColor;
                                    rect.style.strokeWidth = '2px';
                                }
                            });
                            
                            // ä¹Ÿåœ¨çˆ¶ç»„ä¸­æŸ¥æ‰¾
                            let parentGroup = group.parentElement;
                            if (parentGroup && parentGroup.tagName === 'g') {
                                const parentRects = parentGroup.querySelectorAll('rect');
                                parentRects.forEach(rect => {
                                    const width = parseFloat(rect.getAttribute('width') || 0);
                                    if (width > 80) {
                                        rect.setAttribute('fill', fillColor);
                                        rect.setAttribute('stroke', strokeColor);
                                        rect.setAttribute('stroke-width', '2');
                                        rect.style.fill = fillColor;
                                        rect.style.stroke = strokeColor;
                                        rect.style.strokeWidth = '2px';
                                    }
                                });
                            }
                        }
                    }
                });
                
                // æ–¹æ³•2ï¼šé€šè¿‡IDæŸ¥æ‰¾ï¼ˆMermaidä¼šä¸ºæ¯ä¸ªå®ä½“ç”ŸæˆIDï¼‰
                const idPatterns = [
                    `[id*="${tableName}"]`,
                    `[id*="${tableName.replace(/_/g, '-')}"]`,
                    `[id*="${tableName.replace(/_/g, '')}"]`
                ];
                
                idPatterns.forEach(pattern => {
                    try {
                        const elements = svg.querySelectorAll(pattern);
                        elements.forEach(el => {
                            const rects = el.querySelectorAll('rect');
                            rects.forEach(rect => {
                                const width = parseFloat(rect.getAttribute('width') || 0);
                                if (width > 80) {
                                    rect.setAttribute('fill', fillColor);
                                    rect.setAttribute('stroke', strokeColor);
                                    rect.setAttribute('stroke-width', '2');
                                    rect.style.fill = fillColor;
                                    rect.style.stroke = strokeColor;
                                    rect.style.strokeWidth = '2px';
                                }
                            });
                            
                            // å¦‚æœå…ƒç´ æœ¬èº«å°±æ˜¯rect
                            if (el.tagName === 'rect') {
                                const width = parseFloat(el.getAttribute('width') || 0);
                                if (width > 80) {
                                    el.setAttribute('fill', fillColor);
                                    el.setAttribute('stroke', strokeColor);
                                    el.setAttribute('stroke-width', '2');
                                    el.style.fill = fillColor;
                                    el.style.stroke = strokeColor;
                                    el.style.strokeWidth = '2px';
                                }
                            }
                        });
                    } catch (e) {
                        // å¿½ç•¥é€‰æ‹©å™¨é”™è¯¯
                    }
                });
            }
            
            // è®¾ç½®P0ä¼˜å…ˆçº§è¡¨ï¼ˆç»¿è‰²ï¼‰
            p0Tables.forEach(tableName => {
                findAndColorTable(tableName, '#C8E6C9', '#4CAF50');
            });
            
            // è®¾ç½®P1ä¼˜å…ˆçº§è¡¨ï¼ˆæ©™è‰²ï¼‰
            p1Tables.forEach(tableName => {
                findAndColorTable(tableName, '#FFE0B2', '#FF9800');
            });
            
            // è®¾ç½®P2ä¼˜å…ˆçº§è¡¨ï¼ˆç°è‰²ï¼‰
            p2Tables.forEach(tableName => {
                findAndColorTable(tableName, '#E0E0E0', '#9E9E9E');
            });
        }
        
        // ç»˜åˆ¶åŸŸèƒŒæ™¯æ¡†çš„å‡½æ•°
        function drawDomainBoxes() {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) {
                setTimeout(drawDomainBoxes, 500);
                return;
            }
            
            // åˆ é™¤æ—§çš„åŸŸæ¡†
            const oldDomainGroup = svg.querySelector('#domain-boxes');
            if (oldDomainGroup) {
                oldDomainGroup.remove();
            }
            
            // åˆ›å»ºåŸŸåˆ†ç»„å®¹å™¨ï¼Œç¡®ä¿åœ¨æœ€åº•å±‚
            const domainGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            domainGroup.setAttribute('id', 'domain-boxes');
            domainGroup.setAttribute('style', 'pointer-events: none;');
            
            // è·å–SVGçš„æ‰€æœ‰å­å…ƒç´ 
            const svgChildren = Array.from(svg.children);
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªédefsçš„å…ƒç´ ä½ç½®æ’å…¥
            let insertIndex = 0;
            for (let i = 0; i < svgChildren.length; i++) {
                if (svgChildren[i].tagName !== 'defs' && svgChildren[i].id !== 'domain-boxes') {
                    insertIndex = i;
                    break;
                }
            }
            svg.insertBefore(domainGroup, svgChildren[insertIndex] || null);
            
            // ä¸ºæ¯ä¸ªåŸŸç»˜åˆ¶èƒŒæ™¯æ¡†
            Object.keys(domains).forEach(domainName => {
                const domain = domains[domainName];
                const tablePositions = [];
                
                // æ‰¾åˆ°åŸŸä¸­æ‰€æœ‰è¡¨çš„ä½ç½® - ä½¿ç”¨æ›´å…¨é¢çš„æ–¹æ³•
                domain.tables.forEach(tableName => {
                    // æ–¹æ³•1ï¼šé€šè¿‡æ–‡æœ¬æŸ¥æ‰¾è¡¨åï¼ˆè¡¨çš„ç¬¬ä¸€ä¸ªæ–‡æœ¬é€šå¸¸æ˜¯è¡¨åï¼‰
                    const allTexts = svg.querySelectorAll('text');
                    allTexts.forEach(textEl => {
                        const textContent = (textEl.textContent || '').trim();
                        // æ£€æŸ¥æ˜¯å¦ä»¥è¡¨åå¼€å¤´ï¼Œæˆ–è€…åŒ…å«è¡¨å
                        if (textContent.startsWith(tableName) || textContent === tableName) {
                            let group = textEl.closest('g');
                            // å‘ä¸ŠæŸ¥æ‰¾åŒ…å«rectçš„ç»„
                            let maxDepth = 5;
                            while (group && maxDepth > 0) {
                                const rects = group.querySelectorAll('rect');
                                if (rects.length > 0) {
                                    try {
                                        const bbox = group.getBBox();
                                        if (bbox.width > 50 && bbox.height > 30) {
                                            tablePositions.push({
                                                x: bbox.x,
                                                y: bbox.y,
                                                width: bbox.width,
                                                height: bbox.height
                                            });
                                            break;
                                        }
                                    } catch (e) {
                                        // å¿½ç•¥getBBoxé”™è¯¯
                                    }
                                }
                                group = group.parentElement;
                                maxDepth--;
                            }
                        }
                    });
                    
                    // æ–¹æ³•2ï¼šé€šè¿‡IDæŸ¥æ‰¾ï¼ˆMermaidç”Ÿæˆçš„IDï¼‰
                    const idVariations = [
                        tableName,
                        tableName.replace(/_/g, '-'),
                        tableName.replace(/_/g, ''),
                        `er-${tableName}`,
                        `er-${tableName.replace(/_/g, '-')}`
                    ];
                    
                    idVariations.forEach(idVariant => {
                        try {
                            // ç›´æ¥æŸ¥æ‰¾ID
                            const elementById = svg.querySelector(`#${idVariant}`);
                            if (elementById && elementById.tagName === 'g') {
                                try {
                                    const bbox = elementById.getBBox();
                                    if (bbox.width > 50 && bbox.height > 30) {
                                        tablePositions.push({
                                            x: bbox.x,
                                            y: bbox.y,
                                            width: bbox.width,
                                            height: bbox.height
                                        });
                                    }
                                } catch (e) {}
                            }
                            
                            // é€šè¿‡IDåŒ…å«æŸ¥æ‰¾
                            const elements = svg.querySelectorAll(`[id*="${idVariant}"]`);
                            elements.forEach(el => {
                                if (el.tagName === 'g') {
                                    try {
                                        const bbox = el.getBBox();
                                        if (bbox.width > 50 && bbox.height > 30) {
                                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                                            const exists = tablePositions.some(p => 
                                                Math.abs(p.x - bbox.x) < 5 && Math.abs(p.y - bbox.y) < 5
                                            );
                                            if (!exists) {
                                                tablePositions.push({
                                                    x: bbox.x,
                                                    y: bbox.y,
                                                    width: bbox.width,
                                                    height: bbox.height
                                                });
                                            }
                                        }
                                    } catch (e) {}
                                }
                            });
                        } catch (e) {
                            // å¿½ç•¥é€‰æ‹©å™¨é”™è¯¯
                        }
                    });
                    
                    // æ–¹æ³•3ï¼šé€šè¿‡æŸ¥æ‰¾åŒ…å«è¡¨åçš„æ‰€æœ‰gå…ƒç´ ï¼Œç„¶åæ‰¾åˆ°æœ€å¤§çš„rect
                    const allGroups = svg.querySelectorAll('g');
                    allGroups.forEach(group => {
                        const texts = group.querySelectorAll('text');
                        let foundTableName = false;
                        texts.forEach(textEl => {
                            const textContent = (textEl.textContent || '').trim();
                            if (textContent.startsWith(tableName) || textContent === tableName) {
                                foundTableName = true;
                            }
                        });
                        
                        if (foundTableName) {
                            const rects = group.querySelectorAll('rect');
                            let largestRect = null;
                            let maxArea = 0;
                            rects.forEach(rect => {
                                const width = parseFloat(rect.getAttribute('width') || 0);
                                const height = parseFloat(rect.getAttribute('height') || 0);
                                const area = width * height;
                                if (area > maxArea && width > 50 && height > 30) {
                                    maxArea = area;
                                    largestRect = rect;
                                }
                            });
                            
                            if (largestRect) {
                                try {
                                    const bbox = group.getBBox();
                                    if (bbox.width > 50 && bbox.height > 30) {
                                        const exists = tablePositions.some(p => 
                                            Math.abs(p.x - bbox.x) < 10 && Math.abs(p.y - bbox.y) < 10
                                        );
                                        if (!exists) {
                                            tablePositions.push({
                                                x: bbox.x,
                                                y: bbox.y,
                                                width: bbox.width,
                                                height: bbox.height
                                            });
                                        }
                                    }
                                } catch (e) {}
                            }
                        }
                    });
                });
                
                // å»é‡è¡¨ä½ç½®ï¼ˆé¿å…é‡å¤ï¼‰
                const uniquePositions = [];
                tablePositions.forEach(pos => {
                    const isDuplicate = uniquePositions.some(existing => 
                        Math.abs(existing.x - pos.x) < 10 && 
                        Math.abs(existing.y - pos.y) < 10 &&
                        Math.abs(existing.width - pos.width) < 10 &&
                        Math.abs(existing.height - pos.height) < 10
                    );
                    if (!isDuplicate) {
                        uniquePositions.push(pos);
                    }
                });
                
                // å¦‚æœæœ‰è¡¨ï¼Œè®¡ç®—è¾¹ç•Œæ¡†
                if (uniquePositions.length > 0) {
                    let minX = Math.min(...uniquePositions.map(p => p.x));
                    let minY = Math.min(...uniquePositions.map(p => p.y));
                    let maxX = Math.max(...uniquePositions.map(p => p.x + p.width));
                    let maxY = Math.max(...uniquePositions.map(p => p.y + p.height));
                    
                    // æ·»åŠ è¾¹è·
                    const padding = 30;
                    minX -= padding;
                    minY -= padding;
                    maxX += padding;
                    maxY += padding;
                    
                    // ç¡®ä¿åæ ‡æœ‰æ•ˆ
                    if (minX >= 0 && minY >= 0 && maxX > minX && maxY > minY) {
                        // ç»˜åˆ¶èƒŒæ™¯æ¡†
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', minX);
                        rect.setAttribute('y', minY);
                        rect.setAttribute('width', maxX - minX);
                        rect.setAttribute('height', maxY - minY);
                        rect.setAttribute('fill', domain.color);
                        rect.setAttribute('stroke', domain.borderColor);
                        rect.setAttribute('stroke-width', '3');
                        rect.setAttribute('stroke-dasharray', '10,5');
                        rect.setAttribute('rx', '10');
                        rect.setAttribute('opacity', '1');
                        rect.style.pointerEvents = 'none';
                        rect.style.fillOpacity = '0.15';
                        domainGroup.appendChild(rect);
                        
                        // æ·»åŠ åŸŸæ ‡ç­¾èƒŒæ™¯
                        const labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        const labelWidth = domainName.length * 14 + 25;
                        labelBg.setAttribute('x', minX + 8);
                        labelBg.setAttribute('y', minY + 8);
                        labelBg.setAttribute('width', labelWidth);
                        labelBg.setAttribute('height', 28);
                        labelBg.setAttribute('fill', 'white');
                        labelBg.setAttribute('opacity', '0.95');
                        labelBg.setAttribute('rx', '5');
                        labelBg.setAttribute('stroke', domain.borderColor);
                        labelBg.setAttribute('stroke-width', '2.5');
                        labelBg.style.pointerEvents = 'none';
                        domainGroup.appendChild(labelBg);
                        
                        // æ·»åŠ åŸŸæ ‡ç­¾æ–‡æœ¬
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', minX + 20);
                        text.setAttribute('y', minY + 27);
                        text.setAttribute('fill', domain.textColor);
                        text.setAttribute('font-size', '15');
                        text.setAttribute('font-weight', 'bold');
                        text.setAttribute('font-family', 'Arial, "Microsoft YaHei", sans-serif');
                        text.textContent = domainName;
                        text.style.pointerEvents = 'none';
                        domainGroup.appendChild(text);
                    }
                }
            });
            
            // ç¡®ä¿åŸŸæ¡†åœ¨åº•å±‚ï¼šç§»åŠ¨åˆ°æœ€å‰é¢
            svg.insertBefore(domainGroup, svg.firstChild);
        }
        
        // ç­‰å¾…å›¾è¡¨æ¸²æŸ“å®Œæˆåè®¾ç½®é¢œè‰²
        function initializeDiagram() {
            setTableColors();
            // åŸŸæ¡†ç»˜åˆ¶æš‚æ—¶ç¦ç”¨ï¼Œå› ä¸ºæ¡†çº¿æ˜¾ç¤ºæœ‰é—®é¢˜
            // setTimeout(() => {
            //     drawDomainBoxes();
            //     setTimeout(drawDomainBoxes, 1000);
            // }, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // å¤šæ¬¡å°è¯•ï¼Œç¡®ä¿å›¾è¡¨å·²æ¸²æŸ“
            setTimeout(initializeDiagram, 1500);
            setTimeout(initializeDiagram, 2500);
            setTimeout(initializeDiagram, 3500);
            setTimeout(initializeDiagram, 4500);
            setTimeout(initializeDiagram, 5500);
            
            // ç›‘å¬Mermaidæ¸²æŸ“å®Œæˆäº‹ä»¶
            if (window.mermaid) {
                const originalRender = mermaid.render;
                mermaid.render = function(...args) {
                    const result = originalRender.apply(this, args);
                    setTimeout(initializeDiagram, 1500);
                    return result;
                };
            }
        });
        
        // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver(function(mutations) {
                const svg = document.querySelector('.mermaid svg');
                if (svg && svg.querySelectorAll('rect').length > 10) {
                    setTimeout(initializeDiagram, 1000);
                    observer.disconnect();
                }
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
    </script>
    
    <style>
        /* CSSæ ·å¼ä½œä¸ºå¤‡ç”¨ï¼Œä¸»è¦é€šè¿‡JavaScriptåŠ¨æ€è®¾ç½® */
        .mermaid svg rect[data-priority="P0"] {
            fill: #C8E6C9 !important;
            stroke: #4CAF50 !important;
            stroke-width: 2px !important;
        }
        
        .mermaid svg rect[data-priority="P1"] {
            fill: #FFE0B2 !important;
            stroke: #FF9800 !important;
            stroke-width: 2px !important;
        }
        
        .mermaid svg rect[data-priority="P2"] {
            fill: #E0E0E0 !important;
            stroke: #9E9E9E !important;
            stroke-width: 2px !important;
        }
    </style>
</body>
</html>
