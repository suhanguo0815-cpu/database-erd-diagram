# 数据库表关系图 - 可视化版本

## 一、核心关系图（ASCII艺术）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户域 (User Domain)                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌──────────────┐                                      │
│                    │  user_core   │  (主表，已合并user_contacts)          │
│                    │  - userId PK │                                      │
│                    │  - nickname  │                                      │
│                    │  - phone...  │                                      │
│                    └──────┬───────┘                                      │
│                           │                                              │
│        ┌──────────────────┼──────────────────┐                          │
│        │                  │                  │                          │
│        ▼                  ▼                  ▼                          │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │
│ │user_prefs   │  │user_goals   │  │user_subscrip│                     │
│ │1:1关系      │  │1:N关系      │  │tions (1:N)  │                     │
│ │userId PK    │  │userId+ver PK│  │subscriptionId│                     │
│ └─────────────┘  └─────────────┘  └──────┬──────┘                     │
│                                            │                             │
└────────────────────────────────────────────┼─────────────────────────────┘
                                             │
┌────────────────────────────────────────────┼─────────────────────────────┐
│                          服务域 (Service Domain)                          │
├────────────────────────────────────────────┼─────────────────────────────┤
│                                             │                             │
│                    ┌──────────────┐        │                             │
│                    │product_plans │        │                             │
│                    │(模板表)      │        │                             │
│                    └──────┬───────┘        │                             │
│                           │                │                             │
│                           │ 引用           │                             │
│                           ▼                │                             │
│                    ┌──────────────┐        │                             │
│                    │user_subscrip │◄───────┘                             │
│                    │tions         │                                      │
│                    │-subscriptionId│                                      │
│                    │-userId FK     │                                      │
│                    │-productPlanId │                                      │
│                    │-isCurrent     │                                      │
│                    └──────┬───────┘                                      │
│                           │                                              │
│        ┌──────────────────┼──────────────────┐                          │
│        │                  │                  │                          │
│        ▼                  ▼                  ▼                          │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │
│ │  payments   │  │user_service │  │user_service │                     │
│ │  1:N        │  │_assignment  │  │_assignment  │                     │
│ │paymentId PK │  │1:1          │  │_history 1:N │                     │
│ └──────┬──────┘  │userId PK    │  │userId+time  │                     │
│        │         │nutritionist │  │PK           │                     │
│        │         │Id FK        │  │nutritionist │                     │
│        │         └──────┬───────┘  │Id FK        │                     │
│        │                │           └──────┬──────┘                     │
│        │                │                  │                             │
│        │                │                  │                             │
│        │                ▼                  ▼                             │
│        │         ┌──────────────┐  ┌──────────────┐                   │
│        │         │nutritionists  │  │nutritionists │                   │
│        │         │nutritionistId │  │nutritionistId│                   │
│        │         │PK             │  │PK            │                   │
│        │         └──────────────┘  └──────────────┘                   │
│        │                                                                │
│        ▼                                                                │
│ ┌─────────────┐                                                         │
│ │  refunds    │                                                         │
│ │  1:N        │                                                         │
│ │refundId PK  │                                                         │
│ │paymentId FK │                                                         │
│ └─────────────┘                                                         │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                      业务事实域 (Business Facts Domain)                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌──────────────┐                                      │
│                    │  user_core   │                                      │
│                    │  - userId PK │                                      │
│                    └──────┬───────┘                                      │
│                           │                                              │
│        ┌──────────────────┼──────────────────┐                          │
│        │                  │                  │                          │
│        ▼                  ▼                  ▼                          │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │
│ │   meals     │  │   weight    │  │  exercise   │                     │
│ │ 1:N (餐食)  │  │ 1:N (体重)  │  │ 1:N (运动)  │                     │
│ │mealId PK    │  │weightId PK  │  │exerciseId PK│                     │
│ │userId FK    │  │userId FK    │  │userId FK    │                     │
│ │nutritionDe │  │             │  │             │                     │
│ │tails       │  │             │  │             │                     │
│ │antiScore   │  │             │  │             │                     │
│ └─────────────┘  └─────────────┘  └─────────────┘                     │
│        │                  │                  │                          │
│        │                  │                  │                          │
│        ▼                  ▼                  ▼                          │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │
│ │   water     │  │   reports   │  │medical_repo│                     │
│ │ 1:N (喝水)  │  │ 1:N (报告)  │  │rts 1:N      │                     │
│ │waterId PK   │  │reportId PK  │  │reportId PK  │                     │
│ │userId FK    │  │userId FK    │  │userId FK    │                     │
│ │             │  │汇总以上数据  │  │             │                     │
│ └─────────────┘  └─────────────┘  └─────────────┘                     │
│                                                                           │
│                    ┌──────────────┐                                      │
│                    │ conversation │                                      │
│                    │ 1:N (对话)   │                                      │
│                    │conversationId│                                      │
│                    │PK            │                                      │
│                    │userId FK     │                                      │
│                    └──────────────┘                                      │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

## 二、简化关系图（按业务域分类）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          AI营养师小程序数据库结构                          │
└─────────────────────────────────────────────────────────────────────────┘

核心用户表
    user_core (已合并user_contacts)
        │
        ├─→ user_preferences (1:1)          用户偏好设置
        ├─→ user_goals (1:N)                 用户目标（版本化）
        │
        └─→ user_subscriptions (1:N)         订阅/服务
                │
                ├─→ product_plans (N:1)       产品方案模板
                ├─→ payments (1:N)            支付记录
                │       └─→ refunds (1:N)    退款记录
                │
                └─→ user_service_assignment (1:1)     营养师分配
                        │
                        └─→ nutritionists (N:1)       营养师信息
                        │
                        └─→ user_service_assignment_history (1:N)  分配历史

业务事实表 (全部关联user_core)
    user_core
        │
        ├─→ meals (1:N)                       餐食记录（已合并meals_anti_score）
        ├─→ weight (1:N)                      体重记录
        ├─→ exercise (1:N)                   运动记录
        ├─→ water (1:N)                      喝水记录
        ├─→ reports (1:N)                    日报/周报（汇总以上数据）
        ├─→ medical_reports (1:N)            体检报告
        └─→ conversation (1:N)               对话记录
```

## 三、数据流向图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据流向示意                                    │
└─────────────────────────────────────────────────────────────────────────┘

注册流程：
    user_core (创建用户)
        ↓
    user_preferences (设置偏好)
        ↓
    user_goals (设置目标)

订阅流程：
    product_plans (选择方案)
        ↓
    user_subscriptions (创建订阅)
        ↓
    payments (支付)
        ↓
    user_service_assignment (分配营养师)

日常数据采集：
    user_core
        ↓
    ├→ meals (餐食打卡)
    ├→ weight (体重记录)
    ├→ exercise (运动打卡)
    ├→ water (喝水打卡)
    └→ conversation (对话记录)

数据汇总：
    meals + weight + exercise + water
        ↓
    reports (生成报告)
```

## 四、表分组说明

### 组1：用户基础信息（User Core）
- `user_core` - 用户主档（已合并user_contacts）
- `user_preferences` - 用户偏好
- `user_goals` - 用户目标（版本化）

### 组2：服务管理（Service Management）
- `product_plans` - 产品方案模板
- `user_subscriptions` - 订阅/服务（已合并subscriptions和user_service）
- `user_service_assignment` - 营养师分配
- `user_service_assignment_history` - 分配历史
- `nutritionists` - 营养师信息

### 组3：业务事实（Business Facts）
- `meals` - 餐食记录（已合并meals_anti_score，新增nutritionDetails）
- `weight` - 体重记录
- `exercise` - 运动记录
- `water` - 喝水记录
- `reports` - 报告（汇总数据）
- `medical_reports` - 体检报告
- `conversation` - 对话记录

### 组4：财务（Finance）
- `payments` - 支付记录
- `refunds` - 退款记录

## 五、关键查询路径

### 路径1：获取用户完整信息
```
user_core (userId)
  ├─ JOIN user_preferences
  ├─ JOIN user_goals WHERE status='active'
  ├─ JOIN user_subscriptions WHERE isCurrent=true
  │    └─ JOIN product_plans
  └─ JOIN user_service_assignment
       └─ JOIN nutritionists
```

### 路径2：获取用户营养数据（用于报告）
```
user_core (userId)
  ├─ JOIN meals WHERE mealTimeUtc BETWEEN start AND end
  ├─ JOIN weight WHERE measuredAtUtc BETWEEN start AND end
  ├─ JOIN exercise WHERE activityAtUtc BETWEEN start AND end
  └─ JOIN water WHERE drinkAtUtc BETWEEN start AND end
       └─ 汇总生成 reports
```

### 路径3：获取订阅和支付信息
```
user_subscriptions (userId, isCurrent=true)
  ├─ JOIN product_plans
  └─ JOIN payments
       └─ JOIN refunds
```

### 路径4：获取营养师管理的用户
```
nutritionists (nutritionistId)
  └─ JOIN user_service_assignment
       └─ JOIN user_core
            └─ JOIN user_subscriptions WHERE isCurrent=true
```

## 六、表关系类型统计

| 关系类型 | 数量 | 说明 |
|---------|------|------|
| 1:1 | 2 | user_core ↔ user_preferences<br>user_core ↔ user_service_assignment |
| 1:N | 15 | user_core → 所有业务事实表<br>product_plans → user_subscriptions<br>user_subscriptions → payments<br>payments → refunds |
| N:1 | 15 | 所有业务事实表 → user_core<br>user_subscriptions → product_plans<br>payments → user_subscriptions |

## 七、索引建议图

```
主要索引策略：

user_core
  ├─ PK: userId
  ├─ UK: wechatOpenId
  └─ IX: unionId

user_goals
  ├─ PK: (userId, version)
  └─ IX: userId, status='active'

user_subscriptions
  ├─ PK: subscriptionId
  ├─ UK: (userId, isCurrent) WHERE isCurrent=true
  └─ IX: userId, productPlanId, serviceStatus

meals
  ├─ PK: mealId
  └─ IX: (userId, mealTimeUtc DESC), mealType

weight
  ├─ PK: weightId
  └─ IX: (userId, measuredAtUtc DESC)

payments
  ├─ PK: paymentId
  └─ IX: (userId, paidAtUtc DESC), subscriptionId, status
```


