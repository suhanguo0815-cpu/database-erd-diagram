### 建表顺序与索引建议（v1）

#### 一、建表顺序
1) 主数据/字典
- `product_plans`
- `nutritionists`

2) 用户域（唯一/一人一条）
- `user_core`
- `user_contacts`
- `user_preferences`

3) 服务域（快照与事实）
- `subscriptions`
- `user_service`
- `user_service_assignment`
- `user_service_assignment_history`

4) 业务事实
- `meals`
- `meals_anti_score`
- `weight`
- `exercise`
- `water`
- `medical_reports`
- `reports`
- `conversation`

5) 财务
- `payments`
- `refunds`

#### 二、外键关系（逻辑约束）
- `user_service.productPlanId` → `product_plans.productPlanId`
- `user_service.currentSubscriptionId` → `subscriptions.subscriptionId`
- `meals_anti_score.mealId` → `meals.mealId`
- `payments.subscriptionId` → `subscriptions.subscriptionId`
- `refunds.paymentId` → `payments.paymentId`
- `user_service_assignment.nutritionistId` → `nutritionists.nutritionistId`

#### 三、主键与常用索引
- `user_core`: PK(`userId`); IX: `wechatOpenId` UNIQUE（同端）, `unionId`（如需）
- `user_contacts`: PK/UNIQUE(`userId`)
- `user_preferences`: PK/UNIQUE(`userId`)
- `product_plans`: PK(`productPlanId`); IX: `isActive`, `productPlanTier`
- `subscriptions`: PK(`subscriptionId`); IX: (`userId`), (`productPlanId`), (`status`), (`userId`,`currentPeriodEndUtc` DESC), (`nextBillingAtUtc`)
- `user_service`: PK/UNIQUE(`userId`); IX: (`serviceStatus`), (`currentSubscriptionId`)
- `user_service_assignment`: PK/UNIQUE(`userId`); IX: (`nutritionistId`)
- `user_service_assignment_history`: PK(`userId`,`changedAtUtc`,`toNutritionistId`); IX: (`fromNutritionistId`), (`toNutritionistId`)
- `meals`: PK(`mealId`); IX: (`userId`,`mealTimeUtc` DESC), (`mealType`)
- `meals_anti_score`: PK(`mealId`); IX: (`userId`), (`antiScore` DESC)
- `weight`: PK(`weightId`); IX: (`userId`,`measuredAtUtc` DESC)
- `exercise`: PK(`exerciseId`); IX: (`userId`,`activityAtUtc` DESC), (`type`), (`intensity`)
- `water`: PK(`waterId`); IX: (`userId`,`drinkAtUtc` DESC), (`type`)
- `medical_reports`: PK(`reportId`); IX: (`userId`,`reportAtUtc` DESC)
- `reports`: PK(`reportId`); IX: (`userId`,`reportType`,`anchorDate` DESC)
- `conversation`: PK(`conversationId`); IX: (`userId`,`occurredAtUtc` DESC), (`intent`), (`externalIds.wechatMsgId`)
- `payments`: PK(`paymentId`); IX: (`userId`,`paidAtUtc` DESC), (`subscriptionId`), (`status`), (`provider`,`tradeNo` UNIQUE)
- `refunds`: PK(`refundId`); IX: (`paymentId`), (`status`), (`refundedAtUtc` DESC)

#### 四、统一约束与校验
- 时间：全部存 UTC；展示按 `timeZone` 转换。
- 打卡记录：`rawText`/`rawImages` 至少其一存在；图片URL支持多张（建议 ≤9）。
- `meals.mealDescription` 必填；`weight.weightKg` 25.0–300.0（1位小数）。
- 枚举严格校验：`serviceStatus`、`subscriptions.status`、`payments.status`、`refunds.status`、`exercise.type/intensity`、`water.type`、`reports.reportType`。
- 删除策略：建议软删除（`deletedAt`），不级联删除业务事实。

