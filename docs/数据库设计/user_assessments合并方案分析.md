# user_assessments 表合并方案分析

## 一、表结构对比

### `user_assessments` 表特点
- **版本化设计**：`userId + version` 联合主键，支持多次测评
- **字段数量**：约20个字段（包括5个因子得分、多个JSON字段等）
- **更新频率**：低（评估完成后相对稳定）
- **业务定位**：健康评估/人格画像的测评结果

### `user_core` 表特点
- **一对一关系**：每个用户一条记录
- **字段数量**：目前已约18个字段
- **更新频率**：低（基础属性相对稳定）
- **业务定位**：用户基础属性

---

## 二、合并方案对比

### 方案A：合并到 `user_core` 表（简化版本）

**设计**：只保留当前评估结果，不支持历史版本

**合并后的字段**（添加到 `user_core`）：
- `emotionalScore`、`environmentScore`、`cognitionScore`、`agencyScore`、`metabolismScore`
- `personaName`
- `healthConstraints`（JSON）
- `assessmentTimeUtc`
- `source`、`sysPlatform`
- `rawResponsesJson`、`personaProfileJson`、`factorAnalysisJson`、`radarChartJson`（P1优先级）

**优点**：
- ✅ **简化设计**：不需要额外表，减少JOIN
- ✅ **查询方便**：一次查询获取用户完整信息
- ✅ **实现简单**：不需要版本化管理逻辑

**缺点**：
- ❌ **失去版本历史**：无法查看历史评估记录
- ❌ **无法对比**：不能对比不同时期的评估结果
- ❌ **字段冗余**：如果用户不常重新测评，很多字段会长期为空或不更新

---

### 方案B：保持独立表（推荐）

**设计**：保持 `user_assessments` 表，支持版本化

**优点**：
- ✅ **版本历史**：保留历史评估记录，支持对比分析
- ✅ **业务扩展性**：支持用户多次测评，查看变化趋势
- ✅ **逻辑清晰**：评估结果与基础属性分离
- ✅ **查询灵活性**：只在需要时JOIN评估表，不总是需要

**缺点**：
- ❌ **需要JOIN**：查询时需要额外JOIN（但通常只查询当前版本）
- ❌ **表数量多**：多一个表（但这是合理的业务分离）

---

## 三、关键考虑因素

### 1. 版本化需求评估

**问题**：用户是否需要/会多次进行健康评估？

**分析**：
- 如果用户会定期重新评估（如每3个月、6个月），**需要保留版本历史**
- 如果评估是一次性的，或很少重新评估，**可以合并**

**建议**：根据业务情况判断，但通常健康评估会定期更新，建议保留版本化

### 2. 字段使用频率

**分析**：
- **高频使用字段**（每次查询用户信息时都需要）：
  - `personaName`、`healthConstraints`（用于个性化建议）
  - 因子得分（用于快速判断）
  
- **低频使用字段**（只在查看评估详情时需要）：
  - `rawResponsesJson`、`personaProfileJson`、`factorAnalysisJson`、`radarChartJson`
  - 这些是详细数据，不需要每次都查询

**建议**：可以将高频字段合并到 `user_core`，低频字段保留在 `user_assessments`

### 3. 查询性能

**合并到 `user_core`**：
- 一次查询获取所有信息，但字段多，数据量大
- 如果不需要评估信息，也会查询出这些字段

**保持独立表**：
- 查询当前评估：`JOIN user_assessments WHERE isCurrent=true`
- 查询基础信息：仅查询 `user_core`
- 更灵活，性能更好

---

## 四、推荐方案：混合方案（最佳平衡）

### 方案C：混合方案 ⭐ 推荐

**核心思路**：将高频使用的评估结果字段合并到 `user_core`，详细数据保留在 `user_assessments`

### 合并到 `user_core` 的字段（高频使用）

| 字段名 | 类型 | 说明 | 优先级 |
|--------|------|------|--------|
| `personaName` | str | 人格名称（用于个性化建议） | P0 |
| `healthConstraints` | json | 健康约束（用于快速判断） | P0 |
| `emotionalScore` | num | 情绪因子得分（快速参考） | P0 |
| `environmentScore` | num | 环境因子得分（快速参考） | P0 |
| `cognitionScore` | num | 认知因子得分（快速参考） | P0 |
| `agencyScore` | num | 能动性因子得分（快速参考） | P0 |
| `metabolismScore` | num | 代谢因子得分（快速参考） | P0 |
| `lastAssessmentTimeUtc` | timestamp | 最后一次评估时间 | P0 |

**说明**：这些字段在生成营养建议时经常需要，合并后查询方便

### 保留在 `user_assessments` 的字段（详细数据）

| 字段名 | 说明 | 原因 |
|--------|------|------|
| `rawResponsesJson` | 原始问卷数据 | 详细数据，低频使用 |
| `personaProfileJson` | 完整人格画像 | 详细数据，低频使用 |
| `factorAnalysisJson` | 因子分析详情 | 详细数据，低频使用 |
| `radarChartJson` | 雷达图数据 | 详细数据，低频使用 |
| `version` | 版本号 | 版本化管理需要 |
| `source` | 数据来源 | 版本追踪需要 |
| `assessmentTimeUtc` | 评估时间 | 历史记录需要 |

**说明**：这些字段只在查看评估详情或历史记录时需要，保留在独立表中

---

## 五、实施建议

### 方案对比总结

| 维度 | 方案A：完全合并 | 方案B：完全独立 | 方案C：混合方案 ⭐ |
|------|---------------|----------------|------------------|
| **简化程度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **版本历史** | ❌ 无 | ✅ 完整 | ✅ 完整（详细数据） |
| **查询性能** | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **业务扩展性** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **字段冗余** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

### 最终推荐：方案C（混合方案）

**理由**：
1. ✅ **平衡了简化与功能**：高频字段合并，简化查询；详细数据保留，支持版本化
2. ✅ **查询性能最优**：常用的字段在 `user_core`，无需JOIN
3. ✅ **保留版本历史**：详细评估数据保留在 `user_assessments`，支持历史对比
4. ✅ **业务扩展性好**：支持用户多次评估，查看变化趋势

### 实施步骤

1. **在 `user_core` 表新增字段**（高频使用）：
   - `personaName`、`healthConstraints`
   - 5个因子得分字段
   - `lastAssessmentTimeUtc`

2. **保留 `user_assessments` 表**（详细数据）：
   - 保留所有JSON详细字段
   - 保留版本化设计
   - 每次评估时，更新 `user_core` 的高频字段

3. **同步机制**：
   - 新评估完成后，更新 `user_core` 中的高频字段
   - 详细数据保存在 `user_assessments` 的历史记录中

---

## 六、如果选择完全合并（方案A）

如果确定不需要版本历史，可以完全合并，但需要注意：

### 可合并的字段
- 所有评估相关字段都可以合并到 `user_core`

### 失去的功能
- ❌ 无法查看历史评估记录
- ❌ 无法对比不同时期的评估结果
- ❌ 无法追踪评估变化趋势

### 适用场景
- 评估是一次性的，不会重复
- 不需要历史记录和对比分析
- 优先考虑简化设计

---

## 七、最终建议

### ⭐ 推荐：方案C（混合方案）

**核心字段合并到 `user_core`**：
- `personaName`、`healthConstraints`、5个因子得分、`lastAssessmentTimeUtc`

**详细数据保留在 `user_assessments`**：
- 所有JSON详细字段、版本化管理

**优点**：
- ✅ 查询性能好（常用字段无需JOIN）
- ✅ 保留版本历史（详细数据可追溯）
- ✅ 设计简洁（不需要所有字段都合并）
- ✅ 业务扩展性好（支持多次评估）

这样可以兼顾简化设计和功能完整性。


