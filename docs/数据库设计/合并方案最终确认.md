# 表结构合并方案 - 最终确认

## ✅ 已确认的合并方案

### 1. user_core + user_contacts + user_goals

**方案**：user_core 合并 user_contacts，user_goals 保持独立

**结果**：
- ✅ `user_core` 表包含手机号字段（phoneEncrypted, phoneMasked, phoneVerifiedAt）
- ✅ `user_goals` 表保持独立，支持版本化

---

### 2. product_plans + subscriptions + user_service

**方案**：subscriptions + user_service 合并为 user_subscriptions，product_plans 保持独立

**结果**：
- ✅ `user_subscriptions` 表（合并subscriptions + user_service）
  - 使用 `subscriptionId` 作为主键
  - 使用 `isCurrent` 字段标识当前订阅（唯一约束：userId + isCurrent where isCurrent=true）
- ✅ `product_plans` 表保持独立（模板表）

---

### 3. meals + meals_anti_score + nutritionDetails

**方案**：meals 合并 meals_anti_score，新增 nutritionDetails 字段

**结果**：
- ✅ `meals` 表包含所有抗炎评分字段
- ✅ `meals` 表新增 `nutritionDetails` 字段（JSON格式，完整营养素分布）
- ✅ 保留 `nutrition` 字段（简化版，用于兼容）

---

## nutritionDetails 写入格式快速参考

### 基本结构

```json
{
  "nutritionDetails": {
    "macro": {                    // 必填：至少提供proteinG/fatG/carbG中的一个
      "proteinG": 25.5,           // 蛋白质（克）
      "fatG": 15.2,               // 脂肪（克）
      "carbG": 45.8,              // 碳水化合物（克）
      "fiberG": 8.5,              // 膳食纤维（克，可选）
      "sugarG": 12.3,             // 糖（克，可选）
      "starchG": 33.5             // 淀粉（克，可选）
    },
    "minerals": {                  // 可选
      "sodiumMg": 580,            // 钠（毫克）
      "calciumMg": 280,           // 钙（毫克）
      "ironMg": 8.5,              // 铁（毫克）
      "potassiumMg": 420          // 钾（毫克）
      // ... 其他元素
    },
    "vitamins": {                  // 可选
      "vitaminAMg": 0.8,          // 维生素A（毫克）
      "vitaminCMg": 65,           // 维生素C（毫克）
      "vitaminDMg": 0.015,        // 维生素D（微克）
      // ... 其他维生素
    },
    "fattyAcids": {                // 可选
      "saturatedFatG": 5.2,       // 饱和脂肪（克）
      "monounsaturatedFatG": 6.8, // 单不饱和脂肪（克）
      "polyunsaturatedFatG": 3.2, // 多不饱和脂肪（克）
      "transFatG": 0.1            // 反式脂肪（克）
    },
    "aminoAcids": {                // 可选
      "tryptophanG": 0.25,        // 色氨酸（克）
      "leucineG": 1.65            // 亮氨酸（克）
      // ... 其他氨基酸
    },
    "other": {                     // 可选
      "cholesterolMg": 85,        // 胆固醇（毫克）
      "caffeineMg": 0,            // 咖啡因（毫克）
      "waterG": 180               // 水分（克）
    }
  }
}
```

### 必填规则

1. **macro对象**：如果提供nutritionDetails，必须包含macro对象
2. **宏量营养素**：macro中至少提供 `proteinG`、`fatG`、`carbG` 中的一个
3. **数值类型**：所有数值必须是number类型，不允许字符串
4. **非负值**：所有数值必须 >= 0

### 验证规则

- ✅ 数值类型检查：必须是number
- ✅ 非负值检查：所有值 >= 0
- ✅ 一致性检查：脂肪总和、碳水分解等（允许误差）

### API接口

**写入**：`POST /api/meals` 或 `PUT /api/meals/{mealId}`

**请求体**：包含 `nutritionDetails` 字段

**响应**：成功返回完整meal对象，失败返回错误详情

详见：`nutritionDetails写入格式规范.md`


